[ ì ‘ì† URL ]
http://j10a503.p.ssafy.io:8888

[ Script ]


pipeline{
	
	agent any
    
	tools {nodejs "NodeJS"}
	
	environment {
	    DOCKERHUB_CREDENTIALS = credentials('dockerhub')
	    repository = "sulim0314/joa"
	}
	
	stages {
		stage('gitlab Connect'){
			steps{
				git branch: 'dev',
				credentialsId: 'sulim0314',
				url: 'https://lab.ssafy.com/s10-fintech-finance-sub2/S10P22A503.git'
			}
		}

		stage('Dockehub login') {
            steps {
                sh 'echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u $DOCKERHUB_CREDENTIALS_USR --password-stdin' // docker hub ë¡œê·¸ì¸
            }
        }
        
        stage('Build Bank-Backend'){
            steps {
                echo "ğŸš€ Build Bank-Backend Start !!"
                sh '''
                    APP_NAME=bank
                    IMAGE=bank
                    PORT=8010
                
                    cd bank/backend/
                    cp -v /var/jenkins_home/admin_backend/application.yml ./src/main/resources/
                    
                    chmod +x gradlew
                    ./gradlew clean bootJar
                    
                    # Application Stop
                    if [ "$(docker ps -a -q -f name=$APP_NAME)" ]; then
                        echo -n "ğŸš« Stop Docker Container : "
                        docker rm -f $APP_NAME
                    else
                        echo "ğŸš« There is no running container named $APP_NAME"
                    fi
                    
                    # Image Build
                    if [ "$(docker images -a -q $IMAGE)" ]; then
                        echo "ğŸ—‘ï¸ Remove Docker Image : "
                        docker image rm $IMAGE
                    else
                        echo "ğŸ—‘ï¸ There is no Docker image named $IMAGE"
                    fi
                    docker build . -t $IMAGE
                    
                    # Docker Run
                    echo -n "ğŸš€ Docker $APP_NAME Container Start! : "
                    docker run -d \
                    --name $APP_NAME \
                    -p 8010:8080 \
                    --restart=on-failure:10 \
                    $IMAGE
                '''
            }
        }
        
        stage('Build Admin-Backend'){
            steps {
                echo "ğŸš€ Build Admin-Backend Start !!"
                sh '''
                    APP_NAME=admin
                    IMAGE=admin
                    PORT=8030
                
                    cd admin/backend/
                    cp -v /var/jenkins_home/admin_backend/application.yml ./src/main/resources/
                    
                    chmod +x gradlew
                    ./gradlew clean bootJar
                    
                    # Application Stop
                    if [ "$(docker ps -a -q -f name=$APP_NAME)" ]; then
                        echo -n "ğŸš« Stop Docker Container : "
                        docker rm -f $APP_NAME
                    else
                        echo "ğŸš« There is no running container named $APP_NAME"
                    fi
                    
                    # Image Build
                    if [ "$(docker images -a -q $IMAGE)" ]; then
                        echo "ğŸ—‘ï¸ Remove Docker Image : "
                        docker image rm $IMAGE
                    else
                        echo "ğŸ—‘ï¸ There is no Docker image named $IMAGE"
                    fi
                    docker build . -t $IMAGE
                    
                    # Docker Run
                    echo -n "ğŸš€ Docker $APP_NAME Container Start! : "
                    docker run -d \
                    --name $APP_NAME \
                    -p 8030:8080 \
                    --restart=on-failure:10 \
                    $IMAGE
                '''
            }
        }
        
        stage('Build OpenAPI-Backend'){
            steps {
                echo "ğŸš€ Build OpenAPI-Backend Start !!"
                sh '''
                    APP_NAME=openapi
                    IMAGE=openapi
                    PORT=8040
                
                    cd openapi/backend/
                    cp -v /var/jenkins_home/openapi_backend/application.yml ./src/main/resources/
                    
                    chmod +x gradlew
                    ./gradlew clean bootJar
                    
                    # Application Stop
                    if [ "$(docker ps -a -q -f name=$APP_NAME)" ]; then
                        echo -n "ğŸš« Stop Docker Container : "
                        docker rm -f $APP_NAME
                    else
                        echo "ğŸš« There is no running container named $APP_NAME"
                    fi
                    
                    # Image Build
                    if [ "$(docker images -a -q $IMAGE)" ]; then
                        echo "ğŸ—‘ï¸ Remove Docker Image : "
                        docker image rm $IMAGE
                    else
                        echo "ğŸ—‘ï¸ There is no Docker image named $IMAGE"
                    fi
                    docker build . -t $IMAGE
                    
                    # Docker Run
                    echo -n "ğŸš€ Docker $APP_NAME Container Start! : "
                    docker run -d \
                    --name $APP_NAME \
                    -p 8040:8080 \
                    --restart=on-failure:10 \
                    $IMAGE
                '''
            }
        }
        
///////////////////////////////////////////////////////////////////////////////////////////////

        stage('Deploy Docs-front') {
            steps {
                dir('documentation/frontend'){
                    script {
                        // ì´ì „ì— ì‹¤í–‰ì¤‘ì¸ ì»¨í…Œì´ë„ˆê°€ ìˆë‹¤ë©´ ì¤‘ì§€ ë° ì œê±°
                        sh 'docker stop docs-front || true'
                        sh 'docker rm docs-front || true'
                        sh 'docker rmi docs-front || true'
                        
                        // docs-front Docker ì´ë¯¸ì§€ ë¹Œë“œ
                        sh 'docker build -t docs-front .'
                        
                        // docs-front Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰
                        sh 'docker run --restart=on-failure -p 8082:3000 -d --name docs-front docs-front'
                    }
                }
            }
        }
        
        stage('Deploy admin-front') {
            steps {
                dir('admin/frontend'){
                    script {
                        // ì´ì „ì— ì‹¤í–‰ì¤‘ì¸ ì»¨í…Œì´ë„ˆê°€ ìˆë‹¤ë©´ ì¤‘ì§€ ë° ì œê±°
                        sh 'docker stop admin-front || true'
                        sh 'docker rm admin-front || true'
                        sh 'docker rmi admin-front || true'
                        
                        // admin-front Docker ì´ë¯¸ì§€ ë¹Œë“œ
                        sh 'docker build -t admin-front .'
                        
                        // admin-front Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰
                        sh 'docker run --restart=on-failure -p 8083:3000 -d --name admin-front admin-front'
                    }
                }
            }
        }
        
    } // stages
    
    post {
        success {
            script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'good', 
                message: "ë¹Œë“œ ì„±ê³µ: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)", 
                endpoint: 'https://meeting.ssafy.com/hooks/km6h7mxbpf8o3eny9sbgj3kr7y', 
                channel: '503-jenkins'
                )
            }
        }
        failure {
            script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'danger', 
                message: "ë¹Œë“œ ì‹¤íŒ¨: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)", 
                endpoint: 'https://meeting.ssafy.com/hooks/km6h7mxbpf8o3eny9sbgj3kr7y', 
                channel: '503-jenkins'
                )
            }
        }
    } // post
    
    
}
